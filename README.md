# Azure AI Foundry Chat Application

> **Disclaimer:** All files in this repository are generated by GitHub Copilot. This is just sample code with no guarantees.

This project provides a Streamlit-based chat interface integrated with Azure OpenAI services. It allows users to interact with various Azure AI models, upload context files (text, PDF, images), and receive AI-generated responses.

The application can be hosted securely over HTTPS using Azure Container Apps.

## Features

- Interactive chat interface powered by Streamlit.
- Integration with Azure OpenAI models (GPT-3.5 Turbo, GPT-4o, Deepseek-R1, O3 Mini).
- Supports uploading context files (text, PDF, images) for enhanced interactions.
- Secure HTTPS hosting via Azure Container Apps.

## Prerequisites

- Docker installed locally ([Docker Desktop](https://www.docker.com/products/docker-desktop/)).
- Azure subscription with access to Azure OpenAI services.
- Azure CLI installed ([Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli)).

## Initial Azure Setup

1. **Log in to Azure CLI**:

```bash
az login
```

2. **Create a resource group**:

```bash
az group create --name <your-resource-group> --location <your-location>
```

## Environment Variables

Ensure you have the following environment variables set:

- `AZURE_OPENAI_ENDPOINT`: Your Azure OpenAI endpoint URL.
- `AZURE_OPENAI_API_KEY`: Your Azure OpenAI API key.

## Building and Running Locally with Docker

1. **Build the Docker image**:

```bash
docker build -t azureaichatapp .
```

2. **Run the Docker container locally**:

```bash
docker run -p 8501:8501 -e AZURE_OPENAI_ENDPOINT="<your-endpoint>" -e AZURE_OPENAI_API_KEY="<your-api-key>" azureaichatapp
```

3. **Access the application**:

For local development, use `http://localhost:8501` (HTTPS is not configured for localhost).

## Container Registry Setup and Deployment

You can push the image to either Docker Hub or Azure Container Registry (ACR). Choose the option that best suits your needs.

### Option 1: Using Docker Hub

1. **Log in and push to Docker Hub**:

```bash
docker login
docker tag azureaichatapp <your-dockerhub-username>/azureaichatapp:latest
docker push <your-dockerhub-username>/azureaichatapp:latest
```

### Option 2: Using Azure Container Registry (ACR)

1. **Create and set up ACR**:

```bash
az acr create --resource-group <your-resource-group> --name <your-acr-name> --sku Basic
az acr login --name <your-acr-name>
```

2. **Push to ACR**:

```bash
docker tag azureaichatapp <your-acr-name>.azurecr.io/azureaichatapp:latest
docker push <your-acr-name>.azurecr.io/azureaichatapp:latest
```

## Deploying to Azure Container Apps

Deploy the application securely over HTTPS using Azure Container Apps:

```bash
az deployment group create \
  --resource-group <your-resource-group> \
  --template-file infra/container-app.bicep \
  --parameters containerAppName="azure-ai-chat-app" \
               image="<your-image-path>" \
               azureOpenAIEndpoint="<your-endpoint>" \
               azureOpenAIAPIKey="<your-api-key>" \
               registryType="DockerHub"
```

Replace `<your-image-path>` with either:
- Docker Hub: `<your-dockerhub-username>/azureaichatapp:latest`
- ACR: `<your-acr-name>.azurecr.io/azureaichatapp:latest`

If using Azure Container Registry (ACR), add these additional parameters:
```bash
               registryType="ACR" \
               registryName="<your-acr-name>" \
               registryUsername="<registry-username>" \
               registryPassword="<registry-password>"
```

You can get ACR credentials using:
```bash
az acr credential show --name <your-acr-name>
```

### Notes about the deployment
- The container app will be deployed with 1 CPU core and 2GB of memory.
- Environment variables for Azure OpenAI (endpoint and API key) will be automatically configured.
- The application will be accessible securely over HTTPS.

## GitHub Actions CI/CD

This repository includes GitHub Actions workflow for automated container builds and deployments. The workflow:
- Triggers only on pushes to the main branch.
- Builds the Docker image.
- Pushes to either Docker Hub or Azure Container Registry (or both if configured).

### Required GitHub Secrets

Set up the following secrets in your GitHub repository settings:

For Docker Hub:
- `DOCKER_USERNAME`: Your Docker Hub username.
- `DOCKER_PASSWORD`: Your Docker Hub access token.

For Azure Container Registry:
- `AZURE_REGISTRY_URL`: Your ACR login server (e.g., `myregistry.azurecr.io`).
- `AZURE_REGISTRY_USERNAME`: ACR username.
- `AZURE_REGISTRY_PASSWORD`: ACR password.

### Branch Protection

To ensure only authorized changes reach the main branch:
1. Go to Repository Settings > Branches.
2. Add branch protection rule for `main`.
3. Enable:
   - Require pull request reviews.
   - Require status checks to pass.
   - Restrict who can push to matching branches.

## Original Prompts
> Create a Python web app using Streamlit that allows me to call an Azure AI Foundry Endpoint to chat with. I want the user to be able to select a model (listed in a parameter in the app to make sure the developer has a choice which models are allowed). Provide the ability to upload a text file, PDF or image for context in the chat. The endpoint and API key should be configurable using an environment variable but also provide an input option in the web app itself so it can be changed at runtime.

> Create a README file for GitHub using MarkDown that includes instructions on how to build the Docker file and run it locally, instructions on how to deploy this to Azure Container Instances, and Azure Container Apps. Feel free to add this prompt to the README too.

> Create a Bicep and a Terraform file to deploy the Azure Container Instances.

> Can you add a GitHub Action to automate container builds and deployments, and ensure the main branch is protected to prevent abuse?